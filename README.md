# Cup with Handle パターン検出ツール

日本株を対象に「カップ・ウィズ・ハンドル」チャートパターンを検出するツールです。

---

## カップ・ウィズ・ハンドルとは

ウィリアム・オニールが提唱した、**大きく上昇する前の株価に現れやすいチャートパターン**です。

```
        左端(L)                      右端(R)  ← ピボット価格
           ＼                        ／＼
            ＼                      ／  ＼___／ ← ハンドル
             ＼      カップ       ／
              ＼                ／
               ＼    底(B)    ／
                 ￣￣￣￣￣￣
```

**形成の流れ:**
1. 株価が高値(左端)から下落を始める
2. 底を形成し、ゆるやかに回復する（カップ部分）
3. 高値付近まで戻った後、小さな調整が入る（ハンドル部分）
4. ハンドルを上抜けると、大きな上昇が始まることが多い

---

## 検出結果の見方

```
7203.T   Toyota Motor Co  | Score:  84.0 | Cup:  19.0% | Handle:   8.8% | Pivot: ¥2,836
```

| 項目 | 意味 | 理想的な値 |
|------|------|-----------|
| **Score (品質スコア)** | パターンの「お手本度」を0〜100で評価。高いほど教科書的な形 | 70以上が望ましい |
| **Cup (カップ深さ)** | 高値から底までの下落率。深すぎると回復に時間がかかる | 15〜25%が理想 |
| **Handle (ハンドル深さ)** | ハンドル部分の調整率。深すぎると弱いサイン | 5〜12%が理想 |
| **Pivot (ピボット価格)** | この価格を上抜けると買いシグナル発生 | — |

### Trend Template（前提条件）

パターン検出の前に、その銘柄が**上昇トレンドにあるか**を確認しています。

| 条件 | 意味 |
|------|------|
| 株価 > 50日線 > 150日線 > 200日線 | 移動平均線が上昇の順番に並んでいる |
| 200日線が上昇中 | 長期トレンドが上向き |
| 52週安値から25%以上高い | 底値圏から十分に上昇済み |
| 52週高値から25%以内 | 高値圏に近い位置にいる |

**Trend Template未通過**の銘柄は、そもそも上昇トレンドにないため検出対象外となります。

---

## 使い方

### ローカル実行

```bash
# 依存パッケージのインストール
pip install -r requirements.txt

# 指定銘柄をテスト
python main.py 7203 6758 8035

# サンプル銘柄でテスト
python main.py --sample nikkei

# ML予測モード
python main.py 7203 6758 --ml-mode

# 全銘柄スクリーニング（時間がかかります）
python main.py
```

### Docker実行

```bash
# イメージをビルド
./docker-run.sh build       # Linux/macOS/WSL
docker-run.bat build        # Windows

# 指定銘柄をスキャン
./docker-run.sh scan 7203 6758 8035

# サンプルテスト
./docker-run.sh sample nikkei

# ML予測モード
./docker-run.sh ml 7203

# ML訓練
./docker-run.sh train

# バックテスト
./docker-run.sh backtest
```

詳細は [DOCKER.md](DOCKER.md) を参照してください。

---

## 出力ファイル

全銘柄スクリーニング実行時、`output/` フォルダに結果が保存されます。

- `cup_handle_matches_YYYYMMDD_HHMMSS.csv` - パターン検出銘柄のみ
- `cup_handle_all_YYYYMMDD_HHMMSS.csv` - 全銘柄の結果

---

## 重要な注意事項

### このツールでできること
- チャートパターンの**機械的な検出**
- 複数銘柄の**効率的なスクリーニング**

### このツールでできないこと
- **将来の株価予測**
- **投資判断の代行**

### 投資判断の際に必ず確認すべきこと

1. **業績** - 売上・利益は成長しているか
2. **出来高** - ブレイクアウト時に出来高が増加しているか
3. **市場環境** - 相場全体が上昇トレンドか
4. **ファンダメンタルズ** - PER、PBR、財務状況は健全か

---

## バックテスト結果

100銘柄（セクター分散）を対象に、過去3年間のデータでバックテストを実施しました。

### 最適パラメータ

```python
detector = CupHandleDetector(
    cup_min_depth_pct=10.0,   # カップ最小深さ
    cup_max_depth_pct=35.0,   # カップ最大深さ
    handle_max_depth_pct=18.0, # ハンドル最大深さ
    peak_order=10,             # ピーク検出感度
)
```

### パフォーマンス

| 指標 | 値 |
|------|------|
| 総トレード数 | 241 |
| 勝率 | 60.2% |
| 平均リターン | +2.71% |
| シャープレシオ | 1.12 |
| プロフィットファクター | 2.26 |

※ 保有期間20営業日、ストップロス-8%、テイクプロフィット+20%の条件

詳細は `output/backtest_report_final.md` を参照してください。

---

## 機械学習機能

パターン検出の精度向上のため、MLモデルを搭載しています。

### 訓練

```bash
# 合成データで訓練
python ml/train.py --generate-synthetic --n-synthetic 300

# 評価
python ml/evaluate.py
```

### ML予測モード

```bash
# ML予測付きでスキャン
python main.py 7203 6758 --ml-mode
```

### 出力例

```
--- 7203.T ---
  Name: Toyota Motor Corporation
  Pattern Detected: Yes
  Quality Score: 84.0

  [ML Prediction]
  Success Probability: 72.3%
  Confidence: high
  Recommendation: 強い買いシグナル: パターン品質・ML予測ともに良好
```

---

## 免責事項

**本ツールは投資助言ではありません。**

- 検出されたパターンは過去のチャート形状を分析したものであり、将来の株価上昇を保証するものではありません
- 投資判断は必ずご自身の責任で行ってください
- 本ツールの使用により生じた損失について、開発者は一切の責任を負いません
- 投資にはリスクが伴います。余裕資金で行い、分散投資を心がけてください

---

## 参考文献

- ウィリアム・オニール『オニールの成長株発掘法』
- マーク・ミネルヴィニ『ミネルヴィニの成長株投資法』
